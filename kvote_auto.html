<!doctype html>
<html lang="sr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kvote vizuelno ‚Ä¢ Luka (v8 ‚Äì auto 10s + status)</title>
<style>
  :root{ --bg:#0f1222; --card:#161a2f; --muted:#9aa3b2; --txt:#e8ecf5; --line:#232842; --accent:#7c9aff; --accent-2:#8af5c8; --good:#3ddc97; --good-ink:#072117; --bad:#ff6b6b; --bad-ink:#2a0a0a; --pill:#22314f; --best-ring:#f7f7ff; }
  *{box-sizing:border-box}
  body{margin:0; font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--txt)}
  .wrap{max-width:1100px; margin:24px auto 48px; padding:0 16px}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(180deg, rgba(15,18,34,.85), rgba(15,18,34,.6) 60%, transparent);} 
  .bar{display:flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border-bottom:1px solid var(--line)}
  h1{font-size:18px; margin:0; letter-spacing:.3px}
  .spacer{flex:1}
  button{border:1px solid var(--line); background:#1c2240; color:var(--txt); padding:6px 10px; border-radius:12px; cursor:pointer; transition:.15s transform,.2s background; font-size:13px}
  button:hover{background:#242b53} button:active{transform:translateY(1px)}
  .btn-acc{background:linear-gradient(135deg,#6989ff,#76eec6); border:0; color:#0b1430; font-weight:700}
  .btn-ghost{background:#151935}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:var(--pill); color:var(--txt); font-size:11px; border:1px solid var(--line); white-space:nowrap}
  .pill.good{background:var(--good); color:var(--good-ink); font-weight:700}
  .pill.bad{background:var(--bad); color:var(--bad-ink); font-weight:700}
  .controls{display:grid; grid-template-columns:1fr; gap:10px; margin:16px 0 8px}
  @media(min-width:1200px){.controls{grid-template-columns:.8fr .9fr auto}}
  .in{background:#0c0f24; color:var(--txt); border:1px solid var(--line); border-radius:12px; padding:10px 12px}
  textarea.in{height:160px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; display:none}
  .hint{color:var(--muted); font-size:12px; margin-top:2px}
  .content-wrapper{display:flex; gap:20px; align-items:flex-start}
  .sidebar{flex:0 0 220px; position:sticky; top:80px; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; max-height:calc(100vh - 100px); overflow-y:auto}
  .sidebar h3{margin:0 0 10px; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}
  .league-item{padding:8px 10px; margin:4px 0; border-radius:8px; cursor:pointer; font-size:13px; transition:.15s all; border:1px solid transparent}
  .league-item:hover{background:rgba(124,154,255,.1); border-color:var(--line)}
  .league-item.active{background:linear-gradient(135deg,rgba(105,137,255,.2),rgba(118,238,198,.15)); border-color:var(--accent); font-weight:600}
  .league-count{float:right; opacity:.6; font-size:11px}
  .grid{display:grid; grid-template-columns:1fr; gap:14px; flex:1}
  @media(max-width:1000px){.sidebar{display:none}}
  .match{border:1px solid var(--line); border-radius:16px; background:var(--card); overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .head{display:flex; gap:10px; align-items:center; padding:14px 14px; background:linear-gradient(90deg, rgba(124,154,255,.12), rgba(138,245,200,.08)); border-bottom:1px solid var(--line)}
  .teams{font-weight:800; letter-spacing:.2px}
  .meta{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .sub{color:var(--muted); font-size:12px; margin-top:2px}
  .body{padding:12px 14px}
  .stats{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px}
  .stat{border:1px solid var(--line); border-radius:12px; padding:10px; background:linear-gradient(180deg,#171d3b,#121730)}
  .stat h4{margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:#b8c0d6}
  .big{font-size:20px; font-weight:900}
  .bk{opacity:.8; font-size:12px}
  table{width:100%; border-collapse:collapse; margin-top:10px; overflow:auto}
  th,td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left}
  thead th{position:sticky; top:0; background:#151a33; z-index:1}
  td.num{text-align:right; font-variant-numeric:tabular-nums}
  td.num .cell{display:inline-block; padding:2px 6px; border-radius:8px}
  td.num .cell.best{outline:2px solid var(--best-ring); font-weight:800}
  tr:hover td{background:rgba(255,255,255,.02)}
  .footer{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; padding:10px 14px; border-top:1px dashed var(--line)}
  .barwrap{height:6px; background:#0d1130; border-radius:6px; overflow:hidden; border:1px solid #0b0f29}
  .bar{height:100%; width:0}
  .small{font-size:12px; color:var(--muted)}
</style>
<body>
  <header>
    <div class="wrap bar">
      <h1>Vizuelni prikaz kvota</h1>
      <span class="pill" id="pillStatus">status: spremno</span>
      <button id="btnPrint">≈†tampa / PDF</button>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <textarea id="src" class="in" placeholder="Uƒçitani tekst (read-only)"></textarea>
      <input id="q" class="in" placeholder="üîç Filtriraj po timu/ligi‚Ä¶"/>
      <select id="sort" class="in">
        <option value="arbdesc" selected>Sortiraj po profitu 1-X-2 (opadajuƒáe)</option>
        <option value="arbasc">Sortiraj po profitu 1-X-2 (rastuƒáe)</option>
        <option value="arb02desc">Sortiraj po profitu 0-2/3+ (opadajuƒáe)</option>
        <option value="arb02asc">Sortiraj po profitu 0-2/3+ (rastuƒáe)</option>
        <option value="time">Sortiraj po vremenu</option>
        <option value="none">Sortiranje: bez</option>
      </select>
      <div class="small">Automatsko uƒçitavanje podrazumevanog fajla svakih <b>5 minuta</b>.</div>
    </div>

    <div class="content-wrapper">
      <div class="sidebar" id="sidebar">
        <h3>Lige</h3>
        <div id="leagueList"></div>
      </div>
      <div id="out" class="grid"></div>
    </div>
  </div>

<script>
// === Podesi ovde default ime .txt fajla (u ISTOM folderu kao i HTML) ===
const DEFAULT_FILE = 'kvote_arbitraza_FULL.txt';
const AUTO_INTERVAL_MS = 300_000; // 5 minuta (300 sekundi)

// === Parser i pomoƒáne funkcije ===
function parseBlock(txt){
  const parts = txt.split(/\r?\n-{5,}\r?\n/).map(s=>s.trim()).filter(Boolean);
  const matches = parts.map(block=>{
    const lines = block.split(/\r?\n/).map(s=>s.replace(/\r/g,'')).filter(l=>l.trim()!=='');
    const headLines = lines.filter(l=> !l.trim().startsWith('- ') && !/^Najveƒáa/i.test(l) && !/^Arbitra≈æa/i.test(l) );
    
    // Parsiranje vremena, datuma i lige - tra≈æi u prve 3 linije
    const topLines = headLines.slice(0, 3).join(' ');
    const time   = (topLines.match(/(\d{1,2}:\d{2})/) || [])[1] || "";
    const date   = (topLines.match(/(\d{1,2}\.\d{1,2}\.)/) || [])[1] || "";
    const league = (topLines.match(/\[(.+?)\]/) || [])[1] || "";
    
    // Tra≈æi liniju sa timovima (sa "vs")
    const teamsLine = headLines.find(l=>/\bvs\b/i.test(l)) || headLines[1] || "";
    const teams  = teamsLine.replace(/\s+/g,' ').trim();
    
    const bookRows = lines.filter(l=> l.trim().startsWith('- ') );
    const rows = [];
    for(const r of bookRows){
      const m = r.replace(/^- /,'').trim();
      // Pobolj≈°ano: ime kladionice je sve do prvog "=" znaka ili do dvostrukog razmaka
      const firstEqual = m.indexOf('=');
      if(firstEqual === -1) continue; // nema kvota, preskoƒçi
      
      // Naƒëi ime kladionice - sve pre prvog tr≈æi≈°ta
      const beforeEqual = m.substring(0, firstEqual);
      const lastSpace = beforeEqual.lastIndexOf(' ');
      const bName = beforeEqual.substring(0, lastSpace).trim();
      
      // Parsiraj tr≈æi≈°ta
      const pairs = m.slice(bName.length).split('|').map(s=>s.trim()).filter(Boolean);
      const markets = {};
      for(const p of pairs){ 
        const mm = p.match(/^([A-Za-z0-9+&IGG-]+)\s*=\s*([0-9.]+)$/); 
        if(mm){ 
          markets[mm[1]] = parseFloat(mm[2]); 
        } 
      }
      
      if(Object.keys(markets).length > 0){
        rows.push({book:bName, markets});
      }
    }
    return {time,date,league,teams,rows, raw:block};
  });
  
  // Dedupliciraj meƒçeve - spoji kladionice za isti meƒç
  const dedupMap = new Map();
  for(const match of matches){
    const key = `${match.teams}_${match.date}_${match.time}_${match.league}`;
    if(dedupMap.has(key)){
      // Spoji kladionice
      const existing = dedupMap.get(key);
      const existingBooks = new Set(existing.rows.map(r=>r.book));
      for(const row of match.rows){
        if(!existingBooks.has(row.book)){
          existing.rows.push(row);
        }
      }
    } else {
      dedupMap.set(key, match);
    }
  }
  
  return Array.from(dedupMap.values());
}
function bestByMarket(rows, m){ let best={book:null,val:null}; for(const r of rows){ const v=r.markets[m]; if(typeof v==="number" && (!best.val||v>best.val)) best={book:r.book, val:v}; } return best; }
function arbitraza(rows){ const b1=bestByMarket(rows,'1').val, bX=bestByMarket(rows,'X').val, b2=bestByMarket(rows,'2').val; if(!b1||!bX||!b2) return {inv:null,profit:null,ok:false}; const inv=1/b1+1/bX+1/b2; return {inv,profit:(1-inv)*100,ok:inv<1}; }
function arbitraza02(rows, a='0-2', b='3+'){ const ba=bestByMarket(rows,a).val, bb=bestByMarket(rows,b).val; if(!ba||!bb) return {inv:null,profit:null,ok:false}; const inv=1/ba+1/bb; return {inv,profit:(1-inv)*100,ok:inv<1}; }
function scaleByMarket(rows, m){ const vals=rows.map(r=>r.markets[m]).filter(v=>typeof v==="number"); if(!vals.length) return ()=>0; const min=Math.min(...vals), max=Math.max(...vals); return v=> typeof v==="number" ? ((v-min)/Math.max(1e-9,(max-min))) : 0; }

function render(data){
  const out = document.getElementById('out'); out.innerHTML = "";
  const sortVal = document.getElementById('sort').value;
  const withArb = data.map(m=> ({...m, arb: arbitraza(m.rows), arb02: arbitraza02(m.rows)}));
  if(sortVal==='arbdesc')    withArb.sort((a,b)=> (b.arb?.profit??-1e9)  - (a.arb?.profit??-1e9));
  if(sortVal==='arbasc')     withArb.sort((a,b)=> (a.arb?.profit??1e9)   - (b.arb?.profit??1e9));
  if(sortVal==='arb02desc')  withArb.sort((a,b)=> (b.arb02?.profit??-1e9) - (a.arb02?.profit??-1e9));
  if(sortVal==='arb02asc')   withArb.sort((a,b)=> (a.arb02?.profit??1e9)  - (b.arb02?.profit??1e9));
  if(sortVal==='time')       withArb.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

  const needle = document.getElementById('q').value.trim().toLowerCase();
  const selectedLeague = window.selectedLeague || null;
  
  for(const m of withArb){
    if(needle){ const hay=(m.teams+" "+m.league+" "+m.date+" "+m.time).toLowerCase(); if(!hay.includes(needle)) continue; }
    
    // Filtriranje po ligi
    if(selectedLeague){
      const mLeague = m.league ? m.league : '(bez lige)';
      if(mLeague !== selectedLeague) continue;
    }

    const card = document.createElement('div'); card.className='match';
    const head=document.createElement('div'); head.className='head';
    const left=document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
    
    // Datum i vreme iznad timova
    const datetime=document.createElement('div'); datetime.className='sub';
    datetime.textContent=[(m.date||'').trim(),(m.time||'').trim()].filter(Boolean).join(' ');
    
    // Naziv timova
    const title=document.createElement('div'); title.className='teams';
    const teamsTxt=(m.teams && /\bvs\b/i.test(m.teams))? m.teams : ((m.raw.match(/^(?:.*\n)?(.+?\s+vs\s+.+?)\s*$/m)||[])[1]||'(nepoznat meƒç)');
    title.textContent=teamsTxt;
    
    // Liga ispod timova
    const sub=document.createElement('div'); sub.className='sub';
    sub.textContent=m.league?`[${m.league}]`:'';
    
    left.appendChild(datetime); left.appendChild(title); left.appendChild(sub); head.appendChild(left);

    const meta=document.createElement('div'); meta.className='meta';
    const badge=document.createElement('span'); badge.className='pill ' + (m.arb.ok?'good':'bad');
    badge.textContent=m.arb.inv? `Arbitra≈æa (1-X-2): ${m.arb.ok?'DA':'NE'} ¬∑ inv=${m.arb.inv.toFixed(4)} ¬∑ profit‚âà${m.arb.profit.toFixed(2)}%` : 'Arbitra≈æa (1-X-2): ‚Äî';
    const badge2=document.createElement('span'); badge2.className='pill ' + (m.arb02.ok?'good':'bad');
    badge2.textContent=m.arb02.inv? `Arbitra≈æa (0-2/3+): ${m.arb02.ok?'DA':'NE'} ¬∑ inv=${m.arb02.inv.toFixed(4)} ¬∑ profit‚âà${m.arb02.profit.toFixed(2)}%` : 'Arbitra≈æa (0-2/3+): ‚Äî';
    meta.appendChild(badge); meta.appendChild(badge2); head.appendChild(meta); card.appendChild(head);

    const body=document.createElement('div'); body.className='body';
    const b1=bestByMarket(m.rows,'1'), bX=bestByMarket(m.rows,'X'), b2=bestByMarket(m.rows,'2');
    const stats=document.createElement('div'); stats.className='stats';
    stats.innerHTML=[ ['Najveƒáa 1',b1],['Najveƒáa X',bX],['Najveƒáa 2',b2] ].map(([lab,b])=>`<div class="stat"><h4>${lab}</h4><div class="big">${b.val??'‚Äî'}</div><div class="bk">${b.book??''}</div><div class="barwrap"><div class="bar" style="width:${b.val? Math.min(100,(100*Math.pow((b.val/(Math.max(b1.val||0,bX.val||0,b2.val||0)||1)),.8))).toFixed(0):0}%; background:linear-gradient(90deg, var(--accent), var(--accent-2))"></div></div></div>`).join('');
    body.appendChild(stats);

    const mkts=Array.from(new Set(m.rows.flatMap(r=>Object.keys(r.markets)))).sort((a,b)=>{const order=['1','X','2','0-2','2+','3+','GG','IGG','GG&3+','GG&4+','4+']; const ia=order.indexOf(a), ib=order.indexOf(b); return (ia===-1?999:ia)-(ib===-1?999:ib);});
    const bestMap=Object.fromEntries(mkts.map(k=>[k,bestByMarket(m.rows,k).val]));
    const scalers=Object.fromEntries(mkts.map(k=>[k,scaleByMarket(m.rows,k)]));

    const tbl=document.createElement('table'); const thead=document.createElement('thead');
    thead.innerHTML=`<tr><th>Bookmaker</th>${mkts.map(mk=>`<th>${mk}</th>`).join('')}</tr>`; tbl.appendChild(thead);
    const tb=document.createElement('tbody');
    for(const r of m.rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.book}</td>` + mkts.map(k=>{ 
        const v=r.markets[k]; 
        const isBest=v && bestMap[k]===v; 
        const p=scalers[k](v)*100; 
        // Dodaj padding za poravnanje na osnovu broja cifara
        let paddingRight = '12px'; // bazni padding za sve
        if(v){
          const vStr = v.toString();
          const decimalPos = vStr.indexOf('.');
          if(decimalPos === -1){
            // Nema decimalu (npr. "1") - dodaj prostor za ".xx"
            paddingRight = '36px';
          } else {
            const decimals = vStr.length - decimalPos - 1;
            if(decimals === 1){
              // Jedna decimala (npr. "1.1") - dodaj prostor za "x"
              paddingRight = '24px';
            }
            // Za dve decimale (npr. "1.11") koristimo bazni padding od 12px
          }
        }
        const cell=`<span class="cell ${isBest?'best':''}" style="padding-right:${paddingRight}">${v??''}</span>`; 
        return `<td class="num">${cell}<div class="barwrap"><div class="bar" style="width:${p.toFixed(0)}%; background:linear-gradient(90deg, ${isBest?'#8af5c8,#7c9aff':'#434d8b,#2e365f'})"></div></div></td>`; 
      }).join('');
      tb.appendChild(tr);
    }
    tbl.appendChild(tb); body.appendChild(tbl);

    const ft=document.createElement('div'); ft.className='footer'; ft.innerHTML=`<span class="muted">Ukupno kladionica: <b>${m.rows.length}</b></span>`; body.appendChild(ft);

    card.appendChild(body); out.appendChild(card);
  }
  
  // A≈æuriraj sidebar sa ligama
  updateLeagueSidebar(data);
}

function updateLeagueSidebar(data){
  const leagueList = document.getElementById('leagueList');
  if(!leagueList) return;
  
  // Grupi≈°i meƒçeve po ligama
  const leagueCounts = {};
  for(const m of data){
    const league = m.league ? m.league : '(bez lige)';
    leagueCounts[league] = (leagueCounts[league] || 0) + 1;
  }
  
  // Sortiraj lige abecedno
  const leagues = Object.entries(leagueCounts).sort((a,b)=> a[0].localeCompare(b[0]));
  
  leagueList.innerHTML = '';
  
  // Dodaj "Sve lige" opciju
  const allItem = document.createElement('div');
  allItem.className = 'league-item' + (!window.selectedLeague ? ' active' : '');
  allItem.innerHTML = `Sve lige <span class="league-count">${data.length}</span>`;
  allItem.onclick = ()=>{
    window.selectedLeague = null;
    render(parseBlock(srcEl.value));
  };
  leagueList.appendChild(allItem);
  
  // Dodaj svaku ligu
  for(const [league, count] of leagues){
    const item = document.createElement('div');
    item.className = 'league-item' + (window.selectedLeague === league ? ' active' : '');
    item.innerHTML = `${league} <span class="league-count">${count}</span>`;
    item.onclick = ()=>{
      window.selectedLeague = league;
      render(parseBlock(srcEl.value));
    };
    leagueList.appendChild(item);
  }
}

// === Auto uƒçitavanje svakih 10s iz DEFAULT_FILE ===
const srcEl=document.getElementById('src');
const pillStatus=document.getElementById('pillStatus');
const outEl=document.getElementById('out');
const qEl=document.getElementById('q');
const sortEl=document.getElementById('sort');

function setStatus(txt, ok=true){
  pillStatus.textContent = txt;
  pillStatus.className = 'pill ' + (ok ? 'good' : 'bad');
}

async function fetchAndRender(){
  try{
    const url = `${DEFAULT_FILE}?cb=${Date.now()}&r=${Math.random()}`; // pojaƒçan cache-bust
    const started = new Date();
    const resp = await fetch(url, {
      cache:'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const text = await resp.text();
    srcEl.value = text; srcEl.readOnly = true;
    const data = parseBlock(text);
    render(data);
    const t = new Date();
    const hh = t.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    setStatus(`Uƒçitano OK u ${hh} (${((t-started)/1000).toFixed(1)}s)`, true);
  }catch(err){
    const t = new Date();
    const hh = t.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    setStatus(`Gre≈°ka u ${hh}: ${err.message}`, false);
    console.warn('Ne mogu da uƒçitam default .txt', err);
  }
}

// Filter/sort osve≈æavaju prikaz bez novog fetch-a
[qEl, sortEl].forEach(el=>{
  el.addEventListener('input', ()=>{ render(parseBlock(srcEl.value)); });
  el.addEventListener('change', ()=>{ render(parseBlock(srcEl.value)); });
});

document.getElementById('btnPrint').onclick = ()=> window.print();

// Start: odmah uƒçitaj, pa na 10s ponovi
window.addEventListener('DOMContentLoaded', ()=>{
  fetchAndRender();
  setInterval(fetchAndRender, AUTO_INTERVAL_MS);
});
</script>
</body>
</html>